# Project Persistence Implementation

## Overview
Projects are now automatically saved to Supabase database when generated by authenticated users. Anonymous users continue to work with in-memory projects only.

## Database Schema

### `project_files` Table
Stores individual file contents for each project.

```sql
CREATE TABLE project_files (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE NOT NULL,
  path TEXT NOT NULL,
  content TEXT NOT NULL,
  language TEXT DEFAULT 'text',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(project_id, path)
);
```

**Key Features:**
- Foreign key to `projects` table with CASCADE deletion
- Unique constraint on (project_id, path) prevents duplicate files
- RLS policies ensure users can only access their own project files
- Auto-updating timestamp trigger on updates

## Implementation Details

### Backend Changes

**[app/api/generate/route.ts](app/api/generate/route.ts:99-134)**
- Added Supabase client initialization
- Check if user is authenticated
- If authenticated:
  1. Create project record in `projects` table
  2. Insert all files into `project_files` table
  3. Return `projectId` to frontend
- If not authenticated: continue with in-memory project only

### Frontend Changes

**[components/Chat/AiChatPanel.tsx](components/Chat/AiChatPanel.tsx:26-30)**
- Updated `onProjectGenerated` callback to accept optional `projectId` parameter
- Passes both project data and projectId to parent component

**[app/editor/page.tsx](app/editor/page.tsx:113-122)**
- Updated `handleProjectGenerated` to accept projectId parameter
- Added console log for debugging project generation
- Projects are stored locally while projectId is available for future features

## Migration Status

### Pending Action Required ⚠️
The `002_add_project_files.sql` migration needs to be applied manually to Supabase.

**Steps to apply:**
1. Go to: https://supabase.com/dashboard/project/pcxzyzkjjozroyneixxa/sql/new
2. Open: `supabase/migrations/002_add_project_files.sql`
3. Copy all SQL content
4. Paste into Supabase SQL Editor
5. Click "Run"

See [supabase/APPLY_MIGRATIONS.md](supabase/APPLY_MIGRATIONS.md) for detailed instructions.

## User Flow

### Authenticated User Flow
1. User logs in with Google OAuth
2. User enters prompt and clicks "Build with AI"
3. Backend generates project files
4. Backend saves project to `projects` table
5. Backend saves all files to `project_files` table
6. Frontend receives project data + `projectId`
7. Project is both in local state and persisted in database
8. User can return later and load project from database

### Anonymous User Flow
1. User enters prompt without logging in
2. Backend generates project files
3. No database save occurs
4. Frontend receives project data without `projectId`
5. Project exists only in browser memory
6. Project is lost on page refresh

## Security

**Row Level Security (RLS):**
- Users can only read/write their own project files
- Policy checks `projects.user_id = auth.uid()`
- Anonymous users have no database access

**Permissions:**
- Only authenticated users can save projects
- Service role key required for admin operations

## Testing

### Manual Test Steps
1. **Without Authentication:**
   - Generate a project
   - Verify no error in console
   - Verify project appears in editor
   - Refresh page → project should be lost

2. **With Authentication:**
   - Log in with Google
   - Generate a project
   - Check console for: `[Generate] Saved project {id} with {n} files`
   - Verify project appears in editor
   - Check Supabase dashboard → project and files should be in database

## Next Steps

1. ✅ Backend API changes - Complete
2. ✅ Frontend callback changes - Complete
3. ✅ Migration file created - Complete
4. ⏳ **Apply migration to Supabase** - Pending
5. ⏳ Test with authenticated user - Pending
6. ⏳ Implement project loading from database - Future
7. ⏳ Add "My Projects" page to list saved projects - Future

## Files Modified

- `app/api/generate/route.ts` - Added persistence logic
- `components/Chat/AiChatPanel.tsx` - Updated callback signature
- `app/editor/page.tsx` - Handle projectId parameter
- `supabase/migrations/002_add_project_files.sql` - New migration (needs application)
- `supabase/APPLY_MIGRATIONS.md` - Migration instructions (new)
