# Handover Report: File Synchronization Mismatch (Browser vs E2B)

## 1. Issue Overview
There is a persistent **desynchronization** between the User's Browser Editor (WebContainer) and the E2B Sandbox (Remote Environment).
- **E2B Sandbox:** Contains the correct, full Expo project structure (`app/`, `hooks/`, `utils/`, `assets/`, `package.json`, etc.). It lives in `/home/user`.
- **Browser Editor:** Consistently fails to display or persist the core source folders (`app/`, `hooks/`, `utils/`). It only shows config files and `assets/`.

## 2. Root Cause Analysis
1.  **Initial Logic Failure:** The user likely started the session with a generic prompt ("Webbrowser code"), causing `selectStarterTemplate` to choose a **Blank** template instead of **Expo**.
2.  **E2B Defaulting:** The E2B logic (backend) defaulted to the **Expo Template** independently, creating the initial mismatch (Empty Browser vs Full E2B).
3.  **Restoration Failure:** Attempts to manually "inject" the missing files via `<afArtifact>` were generated by the LLM, but the Browser's `ActionRunner` or `FilesStore` appears to have failed to process or persist these files into the UI view.
4.  **Pathing Bug (Fixed):** A bug in `api.e2b.execute.ts` was creating duplicate nested paths (`/home/user/home/user/...`) and pollution at the root (`/hooks`). This **has been fixed**, and the E2B side is now clean.

## 3. Current System State
*   **Backend (E2B):** ✅ **HEALTHY**.
    *   Project Root: `/home/user`.
    *   Cleanup: Root (`/`) and `/user` pollution have been removed.
    *   Process: Port 8081 collision and "zombie process" issues are resolved.
*   **Frontend (Browser):** ❌ **CRITICAL FAILURE**.
    *   Missing `app/`, `hooks/`, `utils/`.
    *   Manual file injections are not reflecting in the File Tree.
*   **Stability:** ✅ **STABLE**.
    *   Fixed a `react-toastify` crash by removing a custom transition.
    *   Enforced "Strict Expo" policy in `selectStarterTemplate`.

## 4. Action Plan for Next Agent
The previous agent (Antigravity) attempted "Push" synchronization (Browser -> E2B). This failed because the Browser state itself is corrupt/incomplete.
**Strategy Shift:** You must implement **"Pull" Synchronization (E2B -> Browser)** or a **Hard State Reset**.

### Recommended Steps:
1.  **Reverse Sync API:** Create a new API route (or use an existing one) to **Read** the full file list from the E2B Container (`/home/user`) and send it to the Browser.
2.  **Frontend Hydration:** Modify `Workbench.client.tsx` or `FilesStore` to accept this "Remote State" and overwrite the local WebContainer state.
3.  **Verify ActionRunner:** Debug why the `<afArtifact>` injection containing `app/_layout.tsx` was ignored. Is there a filter preventing writes to existing (but empty) directories?

## 5. Critical Files Checked
*   `app/routes/api.e2b.execute.ts`: **Fixed**. Handling paths correctly now.
*   `app/utils/selectStarterTemplate.ts`: **Fixed**. Enforced Expo default.
*   `app/lib/runtime/action-runner.ts`: **Suspect**. Check logic for `file` actions.

---
**Signed:** Antigravity (Previous Agent)
**Timestamp:** 2026-01-03
